name: Upload Video to YouTube in Parts

on:
  workflow_dispatch:
    inputs:
      stream_url:
        description: 'Base URL del stream HLS (termina con /1080p60/)'
        required: true
        default: ''
      video_title:
        description: 'Título opcional'
        required: false
        default: ''
      video_description:
        description: 'Descripción'
        required: true
        default: ''

jobs:
  upload-video:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Prepare environment
        run: |
          sudo mkdir -p /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace
          mkdir -p /mnt/workspace/temp_parts

      - name: Install dependencies
        run: |
          pip install --upgrade google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client requests oauth2client tqdm m3u8
          sudo apt update
          sudo apt install -y ffmpeg wget

      - name: Download authentication files
        working-directory: /mnt/workspace
        run: |
          wget --user-agent="Mozilla/5.0" https://github.com/nebulafox92/yt/raw/refs/heads/main/oauth2.json
          wget --user-agent="Mozilla/5.0" https://github.com/nebulafox92/yt/raw/refs/heads/main/script.py

      - name: Download and process segments with absolute URLs
        working-directory: /mnt/workspace
        run: |
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:124.0) Gecko/20100101 Firefox/124.0"

          STREAM_BASE_URL="${{ github.event.inputs.stream_url }}"
          INPUT_TITLE="${{ github.event.inputs.video_title }}"
          INPUT_DESCRIPTION="${{ github.event.inputs.video_description }}"

          YEAR=$(echo "$STREAM_BASE_URL" | awk -F'/' '{print $(NF-9)}')
          MONTH=$(echo "$STREAM_BASE_URL" | awk -F'/' '{print $(NF-8)}')
          DAY=$(echo "$STREAM_BASE_URL" | awk -F'/' '{print $(NF-7)}')

          AUTO_TITLE=$(printf "%02d/%02d/%s" "$DAY" "$MONTH" "$YEAR")

          if [ -n "$INPUT_TITLE" ]; then
            VIDEO_TITLE="$INPUT_TITLE"
          else
            VIDEO_TITLE="$AUTO_TITLE"
          fi

          echo "Stream URL: $STREAM_BASE_URL"
          echo "Video title: $VIDEO_TITLE"
          echo "Video description: $INPUT_DESCRIPTION"

          ##############################
          # Descargar playlist principal
          ##############################
          wget --user-agent="$UA" "${STREAM_BASE_URL}playlist.m3u8" -O master.m3u8

          ###############################################
          # Parseo de segmentos y división en 2 partes
          ###############################################
          python -c "
          import m3u8
          base_url = '${STREAM_BASE_URL}'
          playlist = m3u8.load('master.m3u8')
          segments = [base_url + seg.uri if not seg.uri.startswith('http') else seg.uri for seg in playlist.segments]
          total = len(segments)
          split_point = total // 2 + total % 2
          print(f'Total segments: {total}')
          with open('segments_absolute_part1.txt', 'w') as f:
             f.write('\n'.join(segments[:split_point]))
          with open('segments_absolute_part2.txt', 'w') as f:
             f.write('\n'.join(segments[split_point:]))
          "

          ###############################################
          # DESCARGA DE SEGMENTOS - PARTE 1
          ###############################################
          mkdir -p segs_part1
          rm -f list_part1.txt
          count=0
          while read -r URL; do
            fname=$(printf "seg_%05d.ts" "$count")
            wget --user-agent="$UA" -q --show-progress "$URL" -O "segs_part1/$fname"
            echo "file 'segs_part1/$fname'" >> list_part1.txt
            count=$((count+1))
          done < segments_absolute_part1.txt

          echo "Concatenando parte 1..."
          ffmpeg -f concat -safe 0 -i list_part1.txt -c copy -y /mnt/workspace/temp_parts/part1.ts

          echo "Subiendo parte 1..."
          python script.py --file /mnt/workspace/temp_parts/part1.ts --title "Vector | $VIDEO_TITLE | 1/2" --description "$INPUT_DESCRIPTION"

          rm -r segs_part1 list_part1.txt segments_absolute_part1.txt

          ###############################################
          # DESCARGA DE SEGMENTOS - PARTE 2
          ###############################################
          mkdir -p segs_part2
          rm -f list_part2.txt
          count=0
          while read -r URL; do
            fname=$(printf "seg_%05d.ts" "$count")
            wget --user-agent="$UA" -q --show-progress "$URL" -O "segs_part2/$fname"
            echo "file 'segs_part2/$fname'" >> list_part2.txt
            count=$((count+1))
          done < segments_absolute_part2.txt

          echo "Concatenando parte 2..."
          ffmpeg -f concat -safe 0 -i list_part2.txt -c copy -y /mnt/workspace/temp_parts/part2.ts

          echo "Esperando 2 horas antes del segundo upload..."
          sleep 7200

          echo "Subiendo parte 2..."
          python script.py --file /mnt/workspace/temp_parts/part2.ts --title "Vector | $VIDEO_TITLE | 2/2" --description "$INPUT_DESCRIPTION"

          rm -r segs_part2 list_part2.txt segments_absolute_part2.txt master.m3u8
